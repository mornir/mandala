<template>
    <v-layout row justify-center>
        <v-flex xs7>
            <v-stepper v-model="stepCount" vertical class="grey darken-3">
                <v-stepper-items>
                    <v-stepper-step step="1" :complete="stepCount > 1" editable editIcon="check">
                        Mandant
                    </v-stepper-step>

                    <!-- MANDANT -->
                    <v-stepper-content step="1">
                        <div class="stepCard">
                            <v-layout row wrap justify-center>

                                <v-flex xs4 class="mr-2">
                                    <v-select :items="centres" v-model="mandat.centre_coûts" label="Centre de coûts"></v-select>
                                </v-flex>
                                <v-flex xs5>
                                    <v-select :items="mandants" v-model="mandant" @input="saveMandant" :hint="mandant.département" persistent-hint label="Mandant"></v-select>
                                </v-flex>
                                <v-flex xs9>
                                    <v-text-field v-model="mandat.nom" box label="Nom du mandat"></v-text-field>
                                </v-flex>
                            </v-layout>
                        </div>
                        <v-btn color="primary" @click="stepCount = 2">Suivant</v-btn>
                    </v-stepper-content>
                    <v-stepper-step step="2" editable :complete="stepCount > 2" editIcon="check">Fichiers</v-stepper-step>

                    <!-- Fichiers -->
                    <v-stepper-content step="2">
                        <div class="stepCard">
                            <v-layout row justify-center>
                                <v-flex xs2>
                                    <img src="../assets/Word.png" alt="Word" width="50px">
                                </v-flex>
                                <v-flex xs2>
                                    <img src="../assets/Excel.png" alt="Excel" width="50px">
                                </v-flex>
                                <v-flex xs2>
                                    <img src="../assets/PPT.png" alt="PPT" width="50px">
                                </v-flex>
                                <v-flex xs2>
                                    <img src="../assets/PDF.png" alt="PDF" width="50px">
                                </v-flex>
                            </v-layout>
                            <v-layout class="mb-2" justify-center>
                                <v-flex xs2 v-for="(file, index) in mandat.fichiers" :key="file.fichier">
                                    <input name="file.fichier" v-model.number="file.nombre" type="number" min="0" style="width: 50px;">
                                </v-flex>
                            </v-layout>
                        </div>
                        <v-btn color="primary" @click="stepCount = 3">Suivant</v-btn>
                        <v-btn flat @click="stepCount -= 1">Retour</v-btn>
                    </v-stepper-content>
                    <v-stepper-step step="3" editable editIcon="check" :complete="stepCount > 3">Date d'arrivée et délai</v-stepper-step>

                    <!-- Date d'arrivée et délai -->
                    <v-stepper-content step="3">
                        <div class="stepCard">
                            <v-layout row class="ml-3">
                                <v-flex xs6>
                                    <v-date-picker v-model="arrivée" actions locale="fr-FR" first-day-of-week="1"></v-date-picker>
                                </v-flex>
                                <v-flex xs6>
                                    <v-date-picker v-model="délai" actions locale="fr-FR" first-day-of-week="1" dark></v-date-picker>
                                </v-flex>

                            </v-layout>
                        </div>
                        <v-btn color="primary" @click.native="stepCount = 4">Suivant</v-btn>
                        <v-btn flat @click="stepCount -= 1">Retour</v-btn>
                    </v-stepper-content>
                    <v-stepper-step step="4" editable editIcon="check" :complete="stepCount > 4">Heure et priorité</v-stepper-step>

                    <!-- Heure et priorité -->
                    <v-stepper-content step="4">
                        <div class="stepCard">
                            <v-layout row align-center>
                                <v-flex xs12>
                                    <v-time-picker v-model="mandat.heure" format="24hr"></v-time-picker>
                                </v-flex>
                                <v-flex xs7>

                                    <v-checkbox label="Mandat prioritaire" v-model="mandat.priorité" color="red" :error="mandat.priorité">
                                    </v-checkbox>
                                </v-flex>
                                <v-flex xs5>
                                    <span v-if="mandat.priorité" style="font-size:28px">⏳</span>
                                </v-flex>
                            </v-layout>
                        </div>
                        <v-btn color="primary" @click.native="stepCount = 5">Suivant</v-btn>
                        <v-btn flat @click="stepCount -= 1">Retour</v-btn>
                    </v-stepper-content>
                    <v-stepper-step step="5" editable :complete="stepCount > 5" editIcon="check">Situation de communication</v-stepper-step>

                    <!-- Situation de communication -->
                    <v-stepper-content step="5">
                        <div class="stepCard">
                            <v-layout row wrap justify-center>
                                <v-flex xs8>
                                    <v-text-field box v-model="mandat.public_cible" label="Public cible"></v-text-field>
                                </v-flex>
                                <v-flex xs4 class="mr-2">
                                    <v-select :items="textTypes" v-model="mandat.type" label="Type de texte"></v-select>
                                </v-flex>
                                <v-flex xs4 class="mr-2">
                                    <v-select :items="activities" v-model="mandat.activité" label="Activité"></v-select>
                                </v-flex>

                            </v-layout>
                        </div>
                        <v-btn color="primary" @click="stepCount = 6">Suivant</v-btn>
                        <v-btn flat @click="stepCount -= 1">Retour</v-btn>
                    </v-stepper-content>
                    <v-stepper-step step="6" editable editIcon="check" :complete="stepCount > 6">Traduction</v-stepper-step>

                    <!-- Traduction -->
                    <v-stepper-content step="6">
                        <div class="stepCard">
                            <v-layout row wrap justify-center>

                                <v-flex xs7>
                                    <img src="../assets/germany.svg" alt="German" width="40px" height="40px">
                                    <v-btn icon class="black--text  mb-5" @click.native="toggleDirection">
                                        <v-icon>{{arrowDirection}}</v-icon>
                                    </v-btn>
                                    <img src="../assets/france.svg" alt="French" width="40px" height="40px">
                                </v-flex>
                                <v-flex xs2>
                                    <v-checkbox label="Trados" info hide-details v-model="mandat.TAO" true-value="Oui" false-value="Non" />
                                </v-flex>
                                <v-flex xs9>
                                    <label class="subheading">Charge de travail estimée :
                                        <span class="subheading">
                                            <b>{{pageNumber}}</b>
                                        </span>
                                        <v-slider v-model="chargeTravail" step="25" snap :min="25"></v-slider>
                                    </label>
                                </v-flex>
                                <v-flex xs9>
                                    <label class="subheading">Révision par
                                        <b>{{mandat.réviseur}}</b>
                                        <v-radio-group v-model="mandat.réviseur" row>
                                            <v-radio label="Carine" value="Carine"></v-radio>
                                            <v-radio label="Sarah" value="Sarah"></v-radio>
                                            <v-radio label="Autre" value="Autre"></v-radio>
                                        </v-radio-group>
                                    </label>
                                </v-flex>
                                <v-flex xs9>
                                    <v-text-field box v-if="mandat.réviseur === 'Autre'" label="Autre réviseur" v-model="autreRéviseur"></v-text-field>
                                </v-flex>
                            </v-layout>
                        </div>

                        <v-btn color="primary" @click="stepCount = 7">Suivant</v-btn>
                        <v-btn flat @click="stepCount -= 1">Retour</v-btn>
                    </v-stepper-content>
                    <v-stepper-step step="7" editable editIcon="check" :complete="stepCount > 7">Remarque</v-stepper-step>
                    <v-stepper-content step="7">
                        <v-flex xs12>
                            <v-text-field name="remarque" label="Remarque" textarea v-model="mandat.remarque"></v-text-field>
                        </v-flex>
                        <v-btn flat color="info" @click="createMandat" :loading="loading">Créer le mandat</v-btn>
                        <v-btn flat @click="stepCount -= 1">Retour</v-btn>
                    </v-stepper-content>
                </v-stepper-items>
            </v-stepper>
        </v-flex>
    </v-layout>
</template>

<script>
import { db, auth } from '../firebase'
import Mandat from '@/js/newMandat'
import { mandatFirebase } from '@/js/mandatFirebase'
import bus from '@/js/bus'

export default {
  data() {
    return {
      stepCount: 1,
      loading: false,
      chargeTravail: 25,
      autreRéviseur: null,
      arrivée: new Date(),
      délai: new Date(),
      centres: ['VKF', 'IRV', 'Pool', 'VKG', 'PRAEVENT', 'VKF ZIP AG'],
      arrowDirection: 'arrow_forward',
      textTypes: [
        { text: 'Rédactionnel', value: 'REDAC' },
        { text: 'Technique', value: 'TEC' },
        { text: 'Juridique', value: 'JUR' },
        { text: 'Financier', value: 'FINANC' }
      ],
      activities: [
        'Traduction',
        'Adaptation',
        'Correction',
        'Rédaction',
        'Révision'
      ],
      mandat: Mandat,
      mandant: {}
    }
  },
  methods: {
    createMandat() {
      this.loading = true

      //Format date into JJ/MM/AAAA
      this.mandat.arrivée = new Date(this.arrivée)
        .toLocaleString('fr-FR')
        .substr(0, 10)
      this.mandat.délai = new Date(this.délai)
        .toLocaleString('fr-FR')
        .substr(0, 10)

      this.mandat.traducteur = auth.currentUser.displayName

      if (this.mandat.réviseur === 'Autre') {
        this.mandat.réviseur = this.autreRéviseur
      }

      if (this.chargeTravail === 100) {
        this.mandat.chargeTravail = 12
      } else if (this.chargeTravail === 75) {
        this.mandat.chargeTravail = 8
      } else if (this.chargeTravail === 50) {
        this.mandat.chargeTravail = 6
      } else {
        this.mandat.chargeTravail = 4
      }

      mandatFirebase(this.mandat)
        .then(() => {
          this.loading = false
          this.$router.push('/smartview')
          bus.showSnack = true
        })
        .catch(error => {
          this.loading = false
          console.log('an error', error)
        })
    },
    toggleDirection() {
      if (this.mandat.source === 'DE') {
        this.mandat.source = 'FR'
        this.mandat.cible = 'DE'
        this.arrowDirection = 'arrow_back'
      } else {
        this.mandat.source = 'DE'
        this.mandat.cible = 'FR'
        this.arrowDirection = 'arrow_forward'
      }
    },
    rebind() {
      this.$unbind('mandants')
      this.$bindAsArray(
        'mandants',
        db.ref('mandantsListe/' + this.mandat.centre_coûts)
      )
    },
    saveMandant() {
      this.mandat.mandant = this.mandant.text
      this.mandat.département = this.mandant.département
    }
  },
  computed: {
    pageNumber() {
      if (this.chargeTravail === 25) {
        return 'faible 😁'
      } else if (this.chargeTravail === 50) {
        return 'moyenne 😐'
      } else if (this.chargeTravail === 75) {
        return 'grande 😥'
      } else if (this.chargeTravail === 100) {
        return 'énorme 😵'
      } else {
        return '...'
      }
    }
  },
  created() {
    this.$bindAsArray(
      'mandants',
      db.ref('mandantsListe/' + this.mandat.centre_coûts)
    )
  }
}
</script>

<style>

</style>
